<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Territorios</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ====== No Visitar toggle ======
  (function(){
    const btnNov = document.getElementById('btn-novistar-toggle');
    if (!btnNov) return;
    btnNov.addEventListener('click', () => {
      const currentlyOn = btnNov.getAttribute('data-active') === 'on';
      if (currentlyOn){
        btnNov.setAttribute('data-active','off');
        // disable pick mode if MapApp supports it
        if (window.MapApp?.setNoVisitarPickEnabled) window.MapApp.setNoVisitarPickEnabled(false);
      } else {
        btnNov.setAttribute('data-active','on');
        if (window.MapApp?.setNoVisitarPickEnabled){
          window.MapApp.setNoVisitarPickEnabled(true);
        } else {
          // fallback: dispara modal con el centro del mapa
          const map = window.MapApp?.getMap?.();
          const center = map ? map.getCenter() : {lat: -34.77, lng: -55.83};
          const ev = new CustomEvent('novistar:pick', { detail: { lat: center.lat, lng: center.lng } });
          document.dispatchEvent(ev);
        }
      }
    });
    try{ updateLabelsFabVisibility(); }catch(_){/*ignore*/}
})();
</script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <link rel="stylesheet" href="./app.css" />

  <script src="./app-auth.js"></script>
  <script src="./app-config.js"></script>
  <script src="./revisitas-api.js"></script>
  <script src="./revisitas.app.js"></script>
  <script src="./helpers.js"></script>
  <script src="./app-map.js"></script>
</head>

<body>
  <!-- TOP BAR -->
  <div id="topbar">
    <div class="brand">
      <span id="sheets-status-badge" class="status-badge disconnected" title="Google Sheets no conectado">Sheets OFF</span>
      Territorios
    </div>
        <div id="topbar-actions">
      <div id="auth-box" class="auth-box">
        <span id="auth-info" class="auth-hidden auth-user-label"></span>

        <!-- Bot√≥n abrir login -->
        <button id="btnAuthOpen" class="icon-btn primary" title="Acceder">
          <span class="icon">üë§</span>
        </button>

        <!-- Bot√≥n logout (se puede seguir usando internamente) -->
        <button id="btnLogout" class="icon-btn auth-hidden" title="Salir">
          <span class="icon">‚èè</span>
        </button>

        <!-- Men√∫ desplegable cuando est√° logueado -->
        <div id="auth-menu" class="auth-menu">
          <button class="auth-menu-item" data-view="territorio">Territorio</button>
          <button class="auth-menu-item" data-view="horas">Horas</button>
          <button class="auth-menu-item" data-action="logout">Salir</button>
        </div>
      </div>
    </div>

  </div>

  <!-- AVISO DISTANCIA -->
  <div id="far-banner">‚ö†Ô∏è Est√°s a m√°s de <strong>8 km</strong> del territorio. Las acciones quedaron desactivadas.</div>

  <!-- MAPA -->
  <div id="map"></div>

    <!-- PANEL DE HORAS -->
  <div id="hours-panel" class="hours-panel" style="display:none">
    <div class="hours-header">
      <h2 class="hours-title">Horas del mes actual</h2>
      <div id="hours-month-label" class="hours-month-label"></div>
    </div>

    <div id="hours-calendar" class="hours-calendar"></div>

    <!-- Ventana de detalles del d√≠a -->
    <div id="hours-day-details" class="hours-day-details" style="display:none">
      <div class="hours-day-details-header">
        <span id="hours-day-details-title" class="hours-day-details-title">Registros del d√≠a</span>
        <button id="hours-day-details-close" class="hours-day-details-close" type="button">‚úï</button>
      </div>
      <div id="hours-day-details-body" class="hours-day-details-body">
        <!-- ac√° se llenan los registros -->
      </div>
    </div>

    <div class="hours-form">
      <div id="hours-selected-date" class="hours-selected-date">
        Seleccion√° un d√≠a en el calendario
      </div>

      <label class="hours-label">
        Horas
        <input type="number" id="hours-input" min="0" step="0.25" placeholder="Ej: 1.5">
      </label>

      <label class="hours-label">
        Observaci√≥n
        <textarea id="hours-note" rows="2" placeholder="Visitas, estudios, territorios..."></textarea>
      </label>

      <button id="hours-add-btn" class="btn-primary" type="button">
        Agregar
      </button>
    </div>

    <div class="hours-footer">
      <span>Total del mes:</span>
      <strong id="hours-total">0</strong> h
    </div>
  </div>


  <!-- FAB N√öMEROS (flotante, sobre el mapa, arriba de Ruta) -->
  <button id="btnToggleLabels" class="icon-btn fab-labels" title="Mostrar / ocultar n√∫meros" style="display:none">
    <span class="icon">üî¢</span>
  </button>

  <!-- Bot√≥n Info flotante (solo territorios) -->
  <button id="btn-info-toggle" class="icon-btn fab-info" data-active="off" title="Informaci√≥n de colores" style="display:none">
    <span class="icon" id="icon-info">‚ÑπÔ∏è</span>
  </button>

  <!-- BOTTOM BAR -->
  <div id="bottombar">
    <!-- GPS -->
    <button id="btn-geo" class="bb-item" data-active="off" title="Mi posici√≥n">
      <div class="bb-icon" id="icon-geo">üìç</div>
      <div class="bb-label">Posici√≥n</div>
    </button>

    <!-- Predicaci√≥n semanal -->
    <button id="btn-weekly-panel" class="bb-item" data-active="off" title="Predicaci√≥n semanal">
      <div class="bb-icon" id="icon-weekly">üìÖ</div>
      <div class="bb-label">Predicar</div>
    </button>

    <!-- Casas de familias -->
    <button id="btn-houses-toggle" class="bb-item" data-active="off" title="Casas de familias">
      <div class="bb-icon" id="icon-houses">üè†</div>
      <div class="bb-label">Casas</div>
    </button>

    <!-- Revisitas / Estudios (solo logueado) -->
    <button id="btn-revisitas" class="bb-item" data-active="off" title="Revisitas y Estudios" style="display:none">
      <div class="bb-icon" id="icon-revisitas">üìí</div>
      <div class="bb-label">Revisitas</div>
    </button>

    <!-- Territorios ON/OFF (solo logueado) -->
    <button id="btn-territorios-toggle" class="bb-item" data-active="on" title="Mostrar/Ocultar territorios" style="display:none">
      <div class="bb-icon" id="icon-territorios">üó∫Ô∏è</div>
      <div class="bb-label">Territorios</div>
    </button>

    <!-- Indicaciones / ruta -->
    <button id="btn-route-toggle" class="bb-item" data-active="off" title="Indicaciones">
      <div class="bb-icon" id="icon-route">üöó</div>
      <div class="bb-label">Ruta</div>
    </button>

    <!-- Referencias / info colores (solo logueado) -->
    <button id="btn-info-toggle" class="bb-item" data-active="off" title="Informaci√≥n de colores" style="display:none">
      <div class="bb-icon" id="icon-info">‚ÑπÔ∏è</div>
      <div class="bb-label">Info</div>
    </button>

    <!-- No visitar: toggle visible para todos -->
    <button id="btn-novistar-toggle" class="bb-item" data-active="off" title="Mostrar/Ocultar No visitar">
      <div class="bb-icon" id="icon-novistar">‚õî</div>
      <div class="bb-label">No visitar</div>
    </button>
  </div>

  <!-- PANEL SEMANAL flotante -->
  <div id="weekly-panel" class="weekly-panel" hidden>
    <div class="panel-actions">
      <button id="weekly-minimize" class="panel-action" type="button" title="Minimizar">‚ûñ</button>
    </div>
    <div class="weekly-title">Predicaci√≥n Semanal</div>
    <div class="weekly-hint">Eleg√≠ una salida para verla en el mapa, o mostrarlas todas:</div>

    <button id="weekly-show-all" class="weekly-item weekly-item-all" type="button">
      üë• Mostrar todas las salidas
    </button>

    <div id="weekly-list" class="weekly-list"></div>
  </div>

  <!-- Panel flotante para Revisitas / Estudios -->
  <div id="revisita-panel" class="side-panel" hidden>
    <div class="side-panel-header">
      <div class="side-panel-title">Revisitas / Estudios</div>
      <button id="btn-revisitas-new-map" class="btn-sub" type="button">
        ‚ûï Nueva en mapa
      </button>
    </div>
    <div id="revisita-list" class="side-panel-body">
      <!-- ac√° van las revisitas en forma de lista -->
    </div>
  </div>


  <!-- REFERENCIAS -->
  <div id="referencias">
    <h3>Referencias</h3>
    <div class="referencia"><span class="color-box azul"></span>Se est√° trabajando</div>
    <div class="referencia"><span class="color-box verde"></span>Finalizado &lt; 2 meses</div>
    <div class="referencia"><span class="color-box amarillo"></span>Finalizado 2-3 meses</div>
    <div class="referencia"><span class="color-box rojo"></span>Finalizado 3+ meses</div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="login-overlay" class="overlay">
    <div id="login-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <header class="modal-header">
        <h3 id="login-title" class="modal-title">Iniciar sesi√≥n</h3>
        <button id="login-close" class="modal-close-btn" title="Cerrar">‚úï</button>
      </header>

      <div class="modal-body">
        <div class="form-field">
          <label for="inUser" class="form-label">Usuario</label>
          <input id="inUser" class="form-input" autocomplete="username" />
        </div>

        <div class="form-field">
          <label for="inPass" class="form-label">Contrase√±a</label>
          <input id="inPass" class="form-input" type="password" autocomplete="current-password" />
        </div>

        <div class="form-actions">
          <button id="login-cancel" class="btn-cancel" type="button">Cancelar</button>
          <button id="btnLogin" class="btn-primary" type="button">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL REGISTRAR TERRITORIO -->
  <div id="territorio-overlay" class="overlay">
    <div id="territorio-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="territorio-title">
      <header class="modal-header">
        <h3 id="territorio-title" class="modal-title">Registrar territorio</h3>
        <button id="territorio-close" class="modal-close-btn" title="Cerrar">‚úï</button>
      </header>
      <div id="territorio-body" class="modal-body">
        <!-- din√°mico -->
      </div>
    </div>
  </div>

  <!-- MODAL Revisita / Estudio -->
  <div id="revisita-overlay" class="overlay" style="display:none;">
    <div class="overlay-box small-box">
      <div class="overlay-header">
        <div class="overlay-title">Revisita / Estudio</div>
        <button id="revisita-close" class="overlay-close-btn">‚úñ</button>
      </div>
      <div id="revisita-body" class="overlay-body">
        <!-- ac√° inyectamos el formulario din√°micamente con buildRevisitaFormHTML(...) -->
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="territorio-toast" class="toast"></div>

<script>
  // ====== Toast ======
  function showToast(msg){
    const t = document.getElementById("territorio-toast");
    t.textContent = msg || "";
    t.style.display = msg ? "block" : "none";
    if(msg){
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>t.style.display="none", 3000);
    }
  }
  window.showToast = showToast;

  // ====== DOM refs ======
  const btnAuthOpen    = document.getElementById('btnAuthOpen');
  const btnLogout      = document.getElementById('btnLogout');
  const overlayLogin   = document.getElementById('login-overlay');
  const btnLogin       = document.getElementById('btnLogin');
  const inUser         = document.getElementById('inUser');
  const inPass         = document.getElementById('inPass');
  const btnCloseLogin  = document.getElementById('login-close');
  const btnCancelLogin = document.getElementById('login-cancel');

  const btnGeo         = document.getElementById('btn-geo');
  const iconGeo        = document.getElementById('icon-geo');

  const btnWeekly      = document.getElementById('btn-weekly-panel');
  const iconWeekly     = document.getElementById('icon-weekly');
  const weeklyPanel    = document.getElementById('weekly-panel');
  const weeklyList     = document.getElementById('weekly-list');
  const weeklyMinimize = document.getElementById('weekly-minimize');

  const btnAllWeekly   = document.getElementById('weekly-show-all');

  const btnHouses      = document.getElementById('btn-houses-toggle');
  const iconHouses     = document.getElementById('icon-houses');

  const btnRevisitas   = document.getElementById('btn-revisitas');
  const iconRevisitas  = document.getElementById('icon-revisitas');
  const panelRevisitas = document.getElementById("revisita-panel");
  const revisitaPanel  = document.getElementById('revisita-panel');
  const revisitaList   = document.getElementById('revisita-list');
  const revisitaShowAll= document.getElementById('revisita-show-all');

  const btnTerritorios = document.getElementById('btn-territorios-toggle');
  const iconTerritorios= document.getElementById('icon-territorios');

  const btnLabels      = document.getElementById('btnToggleLabels');
  const iconLabels     = document.getElementById('icon-labels');

  const btnRoute       = document.getElementById('btn-route-toggle');
  const iconRoute      = document.getElementById('icon-route');

  const btnInfo        = document.getElementById('btn-info-toggle');
  const iconInfo       = document.getElementById('icon-info');
  const referenciasBox = document.getElementById('referencias');

  const territorioOverlay = document.getElementById('territorio-overlay');
  const territorioClose   = document.getElementById('territorio-close');

  const loginOverlay      = document.getElementById('login-overlay');

  const revisitaOverlay = document.getElementById('revisita-overlay');
  const revisitaClose   = document.getElementById('revisita-close');
  const revisitaBody    = document.getElementById('revisita-body');

  const novOverlay   = document.getElementById('novistar-overlay');
  const novModal     = document.getElementById('novistar-modal');
  const novCloseBtn  = document.getElementById('novistar-close');
  const novCancelBtn = document.getElementById('novistar-cancel');
  const novSaveBtn   = document.getElementById('novistar-save');
  const novForm      = document.getElementById('novistar-form');

  const novLat = document.getElementById('novistar-lat');
  const novLng = document.getElementById('novistar-lng');
  const novDir = document.getElementById('novistar-direccion');
  const novMot = document.getElementById('novistar-motivo');
  const novCom = document.getElementById('novistar-comentario');

  // ====== Modal cerrar ======
  if (territorioClose){
    territorioClose.addEventListener('click', ()=>{
      territorioOverlay.style.display='none';
    });
  }
  if (territorioOverlay){
    territorioOverlay.addEventListener('click',(e)=>{
      if (e.target===territorioOverlay) territorioOverlay.style.display='none';
    });
  }
  if (loginOverlay){
    loginOverlay.addEventListener('click',(e)=>{
      if (e.target===loginOverlay) loginOverlay.style.display='none';
    });
  }
  if (revisitaClose){
    revisitaClose.addEventListener('click', ()=>{
      revisitaOverlay.style.display='none';
    });
  }
  if (revisitaOverlay){
    revisitaOverlay.addEventListener('click',(e)=>{
      if (e.target===revisitaOverlay) revisitaOverlay.style.display='none';
    });
  }

  // Minimizar con el bot√≥n
  if (weeklyMinimize) {
    weeklyMinimize.addEventListener('click', () => minimizePanel(weeklyPanel));
  }

  // Restaurar al tocar el "chip" (cuando est√° minimizado)
  weeklyPanel.addEventListener('click', (e) => {
    if (weeklyPanel.classList.contains('minimized')) {
      if (e.target && e.target.id === 'weekly-minimize') return;
      restorePanel(weeklyPanel);
    }
  });

  // ===== No visitar modal =====
  function openNovistarModal({ lat, lng }) {
    const novOverlay = document.getElementById('novistar-overlay');
    const novLat     = document.getElementById('novistar-lat');
    const novLng     = document.getElementById('novistar-lng');
    const novDir     = document.getElementById('novistar-direccion');
    const novMot     = document.getElementById('novistar-motivo');
    const novCom     = document.getElementById('novistar-comentario');

    if (!novOverlay || !novLat || !novLng || !novDir || !novMot || !novCom) {
      console.error('Modal No Visitar no est√° inicializado en el DOM.');
      window.showToast?.('Error: el modal no est√° listo. Recarg√° la p√°gina.');
      return;
    }

    novLat.value = lat ?? '';
    novLng.value = lng ?? '';
    novDir.value = '';
    novMot.value = 'agresivo';
    novCom.value = '';

    novOverlay.style.display = 'flex';
  }

  function closeNovistarModal(){
    const overlay = document.getElementById('novistar-overlay');
    const modal   = document.getElementById('novistar-modal');
    if (overlay) overlay.style.display = 'none';
    if (modal)   modal.style.display   = 'none';
    const btn = document.getElementById('btn-novistar-toggle');
    if (btn) btn.setAttribute('data-active','off');
  }

  function updateLabelsFabVisibility(){
    const role = window.AuthApp?.getRole?.() || "";
    const logged = !!(window.AuthApp?.getUsername?.());
    const territoriosOn = (window.MapApp?.areTerritoriosVisible?.() ?? (document.getElementById('btn-territorios-toggle')?.getAttribute('data-active')==='on'));
    const show = logged && territoriosOn && (role === "admin" || role === "capitan");
    if (btnLabels) btnLabels.style.display = show ? "" : "none";
  }

    function updateInfoFabVisibility(){
    if (!btnInfo) return;
    const role = window.AuthApp?.getRole?.() || "";
    const logged = !!(window.AuthApp?.getUsername?.());
    const territoriosOn = (window.MapApp?.areTerritoriosVisible?.()
          ?? (document.getElementById('btn-territorios-toggle')?.getAttribute('data-active')==='on'));
    const show = logged && territoriosOn && (role === "admin" || role === "capitan");
    btnInfo.style.display = show ? "" : "none";
    if (!show){
      btnInfo.setAttribute("data-active","off");
      if (iconInfo) iconInfo.textContent = "‚ÑπÔ∏è";
      if (referenciasBox) referenciasBox.style.display = "none";
    }
  }


  // Cerrar clic fuera de la tarjeta
  novOverlay?.addEventListener('click', (e) => {
    if (e.target === novOverlay) closeNovistarModal();
  });

  // Cerrar con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && novOverlay && novOverlay.style.display === 'flex') {
      closeNovistarModal();
    }
  });

  // Guardar No Visitar
  novForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const payload = {
      lat: parseFloat(novLat.value),
      lng: parseFloat(novLng.value),
      direccion: novDir.value.trim(),
      motivo: novMot.value,
      comentario: novCom.value.trim(),
      fecha: new Date().toISOString(),
      user: (typeof AuthApp !== "undefined" && AuthApp.getUsername ? (AuthApp.getUsername() || "anon") : "anon")
    };

    if (window.MapApp && typeof window.MapApp.saveNoVisitarSuggestion === "function") {
      window.MapApp.saveNoVisitarSuggestion(payload);
    } else {
      window.showToast?.("Sugerencia enviada (mock).");
      console.log("NoVisitar payload:", payload);
    }

    closeNovistarModal();
  });

  // ====== Login modal ======
  function openLogin(){
    overlayLogin.style.display='flex';
    inUser.focus();
  }
  function closeLogin(){
    overlayLogin.style.display='none';
  }

  btnAuthOpen.addEventListener('click', openLogin);
  btnCloseLogin.addEventListener('click', closeLogin);
  btnCancelLogin.addEventListener('click', closeLogin);

  btnLogin.addEventListener('click', () => {
    const u = (inUser.value||'').trim();
    const p = (inPass.value||'').trim();
    if (!u || !p){
      showToast('Ingres√° usuario y contrase√±a');
      return;
    }
    window.AuthApp.doLogin(u,p);
    closeLogin();
  });

  btnLogout.addEventListener('click', () => {
    window.AuthApp.logout();
  });

  // ====== Helpers responsive paneles ======
  function isMobileViewport() {
    return window.matchMedia("(max-width: 767px)").matches;
  }
  function minimizePanel(panelEl) {
    panelEl.classList.add("minimized");
  }
  function restorePanel(panelEl) {
    panelEl.classList.remove("minimized");
  }

    // ========= Helper: saber si hay usuario logueado =========
  function isLogged(){
    try {
      return !!(window.AuthApp && typeof AuthApp.getUsername === "function" && AuthApp.getUsername());
    } catch(e){
      return false;
    }
  }

  // ========= Cambiar vista Territorio / Horas =========
  const mapEl = document.getElementById('map');
  const hoursPanel = document.getElementById('hours-panel');

  const calContainer = document.getElementById('hours-calendar');
  const lblMonth     = document.getElementById('hours-month-label');
  const lblSelected  = document.getElementById('hours-selected-date');
  const inputHours   = document.getElementById('hours-input');
  const inputNote    = document.getElementById('hours-note');
  const btnAddHours  = document.getElementById('hours-add-btn');
  const lblTotal     = document.getElementById('hours-total');
  const detailsBox   = document.getElementById('hours-day-details');
  const detailsTitle = document.getElementById('hours-day-details-title');
  const detailsBody  = document.getElementById('hours-day-details-body');
  const detailsClose = document.getElementById('hours-day-details-close');


  const today = new Date();
  let calYear = today.getFullYear();
  let calMonth = today.getMonth(); // 0-11
  let selectedDate = null; // "YYYY-MM-DD"

  function getCurrentUser(){
    try{
      return (window.AuthApp && AuthApp.getUsername && AuthApp.getUsername()) || "";
    }catch(e){
      return "";
    }
  }

  function getHoursKey(year, month){
    const user = getCurrentUser() || "anon";
    return `HORAS_${user}_${year}-${String(month+1).padStart(2,"0")}`;
  }

  function loadHoursData(year, month){
    const key = getHoursKey(year, month);
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : {};
    }catch(e){
      return {};
    }
  }

  function saveHoursData(year, month, data){
    const key = getHoursKey(year, month);
    try{
      localStorage.setItem(key, JSON.stringify(data));
    }catch(e){}
  }

    function showDayDetails(dateStr){
    if (!detailsBox || !detailsBody || !detailsTitle) return;
    const data = loadHoursData(calYear, calMonth);
    const entries = data[dateStr] || [];
    const [y,m,d] = dateStr.split("-");

    detailsTitle.textContent = `Registros del ${d}/${m}/${y}`;

    if (!entries.length){
      detailsBody.innerHTML = `<div class="hours-day-details-empty">Sin registros para este d√≠a.</div>`;
    } else {
      detailsBody.innerHTML = entries.map((e, idx) => {
        const h = Number(e.hours || 0);
        const note = (e.note || "").trim() || "<span class='hours-day-details-empty'>Sin observaci√≥n</span>";
        return `
          <div class="hours-day-entry">
            <div class="hours-day-entry-hours">${h.toLocaleString(undefined,{maximumFractionDigits:2})} h</div>
            <div class="hours-day-entry-note">${note}</div>
          </div>
        `;
      }).join("");
    }

    detailsBox.style.display = "block";
  }

  if (detailsClose){
    detailsClose.addEventListener('click', ()=>{
      detailsBox.style.display = "none";
    });
  }


  function buildHoursCalendar(){
    if (!calContainer) return;
    const data = loadHoursData(calYear, calMonth);
    calContainer.innerHTML = "";

    const dayNames = ["L","M","X","J","V","S","D"];
    dayNames.forEach(d=>{
      const h = document.createElement('div');
      h.className = "hours-day-header";
      h.textContent = d;
      calContainer.appendChild(h);
    });

    const first = new Date(calYear, calMonth, 1);
    // Lunes = 0
    let startWeekday = (first.getDay() + 6) % 7;
    const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

    for (let i=0; i<startWeekday; i++){
      const empty = document.createElement('div');
      calContainer.appendChild(empty);
    }

    let monthTotal = 0;

    for (let day=1; day<=daysInMonth; day++){
      const dateStr = `${calYear}-${String(calMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const entries = data[dateStr] || [];
      const totalDay = entries.reduce((acc,e)=> acc + (Number(e.hours) || 0), 0);
      monthTotal += totalDay;

      const cell = document.createElement('div');
      cell.className = "hours-day";
      if (dateStr === selectedDate) cell.classList.add("selected");

      const num = document.createElement('div');
      num.className = "hours-day-number";
      num.textContent = day;
      cell.appendChild(num);

      if (totalDay > 0){
        const badge = document.createElement('div');
        badge.className = "hours-day-total";
        badge.textContent = totalDay.toLocaleString(undefined,{maximumFractionDigits:2});
        cell.appendChild(badge);
      }

      cell.addEventListener('click', ()=>{
        selectedDate = dateStr;
        if (lblSelected){
          const [y,m,d] = dateStr.split("-");
          lblSelected.textContent = `D√≠a seleccionado: ${d}/${m}/${y}`;
        }
        if (inputHours) inputHours.value = "";
        if (inputNote)  inputNote.value  = "";

        buildHoursCalendar();      // repinta calendario marcando seleccionado
        showDayDetails(dateStr);   // muestra ventanita con registros del d√≠a
      });


      calContainer.appendChild(cell);
    }

    if (lblMonth){
      const monthNames = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","setiembre","octubre","noviembre","diciembre"];
      lblMonth.textContent = `${monthNames[calMonth]} ${calYear}`;
    }
    if (lblTotal){
      lblTotal.textContent = monthTotal.toLocaleString(undefined,{maximumFractionDigits:2});
    }
  }

  if (btnAddHours){
    btnAddHours.addEventListener('click', ()=>{
      if (!selectedDate){
        window.showToast?.("Seleccion√° primero un d√≠a en el calendario.");
        return;
      }
      const h = Number(inputHours?.value || 0);
      if (!h || h <= 0){
        window.showToast?.("Ingres√° una cantidad de horas mayor a 0.");
        return;
      }
      const note = (inputNote?.value || "").trim();
      const data = loadHoursData(calYear, calMonth);
      if (!data[selectedDate]) data[selectedDate] = [];
      data[selectedDate].push({ hours: h, note });
       saveHoursData(calYear, calMonth, data);
      if (inputHours) inputHours.value = "";
      if (inputNote)  inputNote.value  = "";
      buildHoursCalendar();
      if (selectedDate){
        showDayDetails(selectedDate);
      }
      window.showToast?.("Horas agregadas.");
    });
  }

function setViewMode(mode){
  if (!mapEl || !hoursPanel) return;

  const btnRuta = document.getElementById("btnRoute"); // ‚Üê tu bot√≥n Ruta

  if (mode === "horas"){
    // Mostrar panel de horas
    mapEl.style.display = "none";
    hoursPanel.style.display = "flex";

    // Ocultar bot√≥n Ruta
    if (btn-route-toggle) btnRuta.style.display = "none";

    selectedDate = null;
    if (lblSelected){
      lblSelected.textContent = "Seleccion√° un d√≠a en el calendario";
    }

    buildHoursCalendar();
  } 
  else {
    // Volver a mapa normal
    mapEl.style.display = "";
    hoursPanel.style.display = "none";

    // Mostrar bot√≥n Ruta nuevamente
    if (btnRuta) btnRuta.style.display = "";
  }
}


  // ========= Men√∫ hover sobre bot√≥n usuario =========
  const authBox   = document.getElementById('auth-box');
  const authMenu  = document.getElementById('auth-menu');

  if (authBox && authMenu){
    // Click en el √°rea del usuario (icono + etiqueta)
    authBox.addEventListener('click', (ev)=>{
      // Si se hizo click dentro del propio submen√∫, dejamos que lo maneje el handler de abajo
      if (ev.target.closest('#auth-menu')) return;

      if (!isLogged()){
        // Si no est√° logueado, abrir login
        const btnAuthOpen = document.getElementById('btnAuthOpen');
        btnAuthOpen && btnAuthOpen.click();
        return;
      }

      // Si est√° logueado, toggle de visibilidad del submen√∫
      const visible = authMenu.style.display === "flex";
      authMenu.style.display = visible ? "none" : "flex";
    });

    // Clic fuera del auth-box => ocultar men√∫
    document.addEventListener('click', (ev)=>{
      if (!authBox.contains(ev.target)){
        authMenu.style.display = "none";
      }
    });

    // Click en opciones del submen√∫
    authMenu.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('.auth-menu-item');
      if (!btn) return;

      const view   = btn.dataset.view;
      const action = btn.dataset.action;

      if (view === "territorio"){
        setViewMode("territorio");
      } else if (view === "horas"){
        setViewMode("horas");
      } else if (action === "logout"){
        btnLogout && btnLogout.click();
      }

      authMenu.style.display = "none";
    });
  }


  // ====== Estado local ======
  let weeklyActive    = false;


  // ====== Geolocalizaci√≥n ======
  btnGeo.addEventListener('click', async () => {
    const active = window.MapApp.isGeoActive();
    if (active) {
      window.MapApp.stopGeo();
      btnGeo.setAttribute("data-active","off");
      iconGeo.textContent = "üìç";
    } else {
      window.MapApp.setWeeklyRoutingEnabled(weeklyActive);
      const ok = await window.MapApp.startGeo();
      if (ok){
        btnGeo.setAttribute("data-active","on");
        iconGeo.textContent = "üì°";
      }
    }
  });

  document.addEventListener('geo:state', (e)=>{
    const active = !!(e.detail && e.detail.active);
    btnGeo.setAttribute("data-active", active ? "on" : "off");
    iconGeo.textContent = active ? "üì°" : "üìç";
  });

  // ====== Mostrar / Ocultar N√∫meros ======
  btnLabels.addEventListener('click', () => {
    if (btnLabels.disabled) return;
    const nowOn = window.MapApp.toggleLabels();
    if (nowOn){
      btnLabels.setAttribute("data-active","on");
      if (iconLabels) iconLabels.textContent = "üëÅÔ∏è";
    } else {
      btnLabels.setAttribute("data-active","off");
      if (iconLabels) iconLabels.textContent = "üëÅÔ∏è";
    }
  });

  // ====== Mostrar / Ocultar Territorios ======
  if (btnTerritorios){
    btnTerritorios.addEventListener('click', () => {
      const visibleNow = (window.MapApp && window.MapApp.toggleTerritoriosLayer)
        ? !!window.MapApp.toggleTerritoriosLayer()
        : false;

      btnTerritorios.setAttribute("data-active", visibleNow ? "on" : "off");
      if (iconTerritorios) iconTerritorios.textContent = visibleNow ? "üó∫Ô∏è" : "‚ùå";

      if (typeof updateLabelsFabVisibility === "function") updateLabelsFabVisibility();
      if (typeof updateInfoFabVisibility === "function") updateInfoFabVisibility();
    });
  }

  // ====== Mostrar / Ocultar Casas ======
  btnHouses.addEventListener('click', () => {
    const visibleNow = window.MapApp.toggleHouses();
    if (visibleNow){
      btnHouses.setAttribute("data-active","on");
      iconHouses.textContent = "üè†";
    } else {
      btnHouses.setAttribute("data-active","off");
      iconHouses.textContent = "üè†";
    }
  });

  // Inicializar visibilidad bot√≥n "N√∫meros"
  updateLabelsFabVisibility();

  // ====== Predicaci√≥n Semanal ======
  btnWeekly.addEventListener('click', async () => {
    weeklyActive = !weeklyActive;
    window.MapApp.setWeeklyRoutingEnabled(weeklyActive);

    if (!weeklyActive){
      btnWeekly.setAttribute("data-active","off");
      iconWeekly.textContent = "üìÖ";

      weeklyPanel.hidden = true;
      restorePanel(weeklyPanel);

      if (window.MapApp.clearWeeklyLayer) {
        window.MapApp.clearWeeklyLayer();
      }
      window.MapApp.clearWeeklyPoint();
      window.MapApp.clearRoute();

      btnRoute.setAttribute("data-active","off");
      iconRoute.textContent = "üöó";
      return;
    }

    btnWeekly.setAttribute("data-active","on");
    iconWeekly.textContent = "‚úÖ";

    restorePanel(weeklyPanel);
    weeklyPanel.hidden = false;

    window.MapApp.clearWeeklyPoint();
    window.MapApp.clearRoute();
    btnRoute.setAttribute("data-active","off");
    iconRoute.textContent = "üöó";

    weeklyList.innerHTML = "";
    const items = window.MapApp.getWeeklyPoints();

    if (btnAllWeekly){
      btnAllWeekly.onclick = () => {
        window.MapApp.showWeeklyLayerWithRoutingOnClick();
        window.MapApp.clearWeeklyPoint();
        window.MapApp.clearRoute();
        btnRoute.setAttribute("data-active","off");
        iconRoute.textContent = "üöó";
        minimizePanel(weeklyPanel);
      };
    }

    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'weekly-item';
      div.textContent = it.dia + ' ' + it.hora + ' | ' + it.label ;

      div.addEventListener('click', async () => {
        await window.MapApp.showSingleWeeklyPoint(idx);
        if (weeklyActive && window.MapApp.isGeoActive()){
          btnRoute.setAttribute("data-active","on");
          iconRoute.textContent = "üõ£Ô∏è";
        } else {
          btnRoute.setAttribute("data-active","off");
          iconRoute.textContent = "üöó";
        }
        minimizePanel(weeklyPanel);
      });

      weeklyList.appendChild(div);
    });
  });

 
  // ====== Bot√≥n Ruta ======
  btnRoute.addEventListener('click', async () => {
    const isOn = btnRoute.getAttribute("data-active") === "on";

    if (isOn) {
      window.MapApp.clearRoute();
      btnRoute.setAttribute("data-active","off");
      iconRoute.textContent = "üöó";
      return;
    }

    const ok = await window.MapApp.ensureRouteWithGeo();

    if (ok) {
      btnRoute.setAttribute("data-active","on");
      iconRoute.textContent = "üõ£Ô∏è";
    } else {
      btnRoute.setAttribute("data-active","off");
      iconRoute.textContent = "üöó";
    }
  });

  // ====== Info colores toggle ======
  btnInfo.addEventListener('click', ()=>{
    const active = btnInfo.getAttribute("data-active") === "on";
    if (active){
      btnInfo.setAttribute("data-active","off");
      iconInfo.textContent = "‚ÑπÔ∏è";
      referenciasBox.style.display = "none";
    } else {
      btnInfo.setAttribute("data-active","on");
      iconInfo.textContent = "‚ùå";
      referenciasBox.style.display = "block";
    }
  });

  // ====== Init ======
  (async function boot(){
    const ok = await (async function waitFor(cond, timeoutMs){
      const start = Date.now();
      return new Promise((resolve)=>{
        (function loop(){
          if (cond()) return resolve(true);
          if (Date.now() - start > timeoutMs) return resolve(false);
          requestAnimationFrame(loop);
        })();
      });
    })(() => !!window.MapApp, 4000);

    if (!ok || !window.MapApp){
      console.error('MapApp no est√° disponible. Revis√° errores de app-map.js.');
      showToast('No se pudo inicializar el mapa.');
      return;
    }

    await window.MapApp.init();
    await window.MapApp.ready;

    if (typeof btnLabels !== 'undefined' && btnLabels) {
      btnLabels.disabled = false;
      btnLabels.classList.remove("bb-disabled");
    }

        // restaurar sesi√≥n (esto ajusta UI seg√∫n rol)
    await window.AuthApp.restore();
    updateLabelsFabVisibility();

  })();
</script>

<!-- Modal No Visitar -->
<div id="novistar-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">Sugerir "No visitar"</div>
      <button id="novistar-close" class="modal-close-btn" type="button">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="novistar-form">
        <input type="hidden" id="novistar-lat">
        <input type="hidden" id="novistar-lng">

        <label for="novistar-comentario">Comentario</label>
        <textarea id="novistar-comentario"></textarea>

        <div class="form-actions">
          <button id="novistar-save" class="btn-primary" type="button">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  function qs(id){ return document.getElementById(id); }
  function setSheetsCsvStatus(ok){
    const el = qs('sheets-status-badge');
    if(!el) return;
    el.classList.remove('ok','disconnected');
    if(ok){
      el.classList.add('ok');
      el.textContent = 'Sheets ON';
      el.title = 'Google Sheets conectado';
    } else {
      el.classList.add('disconnected');
      el.textContent = 'Sheets OFF';
      el.title = 'Google Sheets no conectado o no publicado';
    }
  }
  window.setSheetsCsvStatus = setSheetsCsvStatus;

  async function checkOnce(){
    try{
      const cfg = window.APP_CONFIG || {};
      const url = cfg.SHEETS_TERRITORIOS_CSV_URL;
      if(!url){ setSheetsCsvStatus(false); return; }
      const res = await fetch(url, { cache: 'no-store', redirect: 'follow' });
      setSheetsCsvStatus(res && res.ok);
    }catch(e){
      setSheetsCsvStatus(false);
    }
  }

  function monitorSheetsCsv(){
    checkOnce();
    setInterval(checkOnce, 5 * 60 * 1000);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', monitorSheetsCsv);
  }else{
    monitorSheetsCsv();
  }
})();
</script>

<!-- Sheets help overlay -->
<div id="sheets-help-overlay" class="overlay" style="display:none">
  <div class="overlay-box">
    <div class="overlay-header">
      <h3 class="overlay-title">Conectar Google Sheets (CSV)</h3>
      <button class="overlay-close-btn" onclick="closeSheetsHelp()">Cerrar</button>
    </div>
    <div class="overlay-body">
      <ol style="margin:0; padding-left:18px">
        <li>En tu Google Sheet, ve a <strong>Archivo ‚Üí Publicar en la web</strong>.</li>
        <li>Seleccion√° la <strong>pesta√±a</strong> que usa el mapa (la que contiene los datos).</li>
        <li>Formato: <strong>CSV</strong> y public√°. Copi√° el enlace generado.</li>
        <li>Verific√° que el enlace contenga <code>gid=&lt;n√∫mero&gt;</code> de esa pesta√±a.</li>
        <li>Peg√° ese enlace en <code>APP_CONFIG.SHEETS_TERRITORIOS_CSV_URL</code> o debajo para probar.</li>
      </ol>
      <hr style="border:none; border-top:1px solid #e5e7eb; margin:12px 0">
      <div style="display:grid; gap:10px">
        <label>GID de la pesta√±a (opcional para construir URL r√°pidamente)
          <input id="sheets-gid-input" placeholder="Ej: 1217453780" style="width:100%">
        </label>
        <button class="btn" onclick="buildCsvUrlFromGid()">Construir URL CSV desde GID</button>
        <label>URL CSV construida / actual
          <input id="sheets-url-output" style="width:100%" readonly>
        </label>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" onclick="saveSheetsUrlToConfig()">Usar esta URL ahora</button>
          <button class="btn" onclick="copyCurrentSheetsUrl()">Copiar URL actual</button>
          <button class="btn" onclick="recheckSheetsStatus()">Revisar estado</button>
          <a id="sheets-open-url" class="btn" target="_blank" href="#">Abrir URL</a>
        </div>
        <p class="hint">Si la URL devuelve 404/403, asegurate de que el Sheet est√© <em>publicado</em> y que el GID sea el de la pesta√±a correcta.</p>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function qs(id){ return document.getElementById(id); }
  function getAppCfg(){ return window.APP_CONFIG || {}; }

  window.openSheetsHelp = function(){
    const o = qs('sheets-help-overlay');
    if(!o) return;
    const url = (getAppCfg().SHEETS_TERRITORIOS_CSV_URL || "").trim();
    const out = qs('sheets-url-output');
    if (out) out.value = url;
    const link = qs('sheets-open-url');
    if (link) link.href = url || "#";
    o.style.display = "flex";
  };

  window.closeSheetsHelp = function(){
    const o = qs('sheets-help-overlay');
    if(!o) return;
    o.style.display = "none";
  };

  window.buildCsvUrlFromGid = function(){
    const gid = (qs('sheets-gid-input')?.value || "").trim();
    if(!gid){ alert("Ingres√° un GID num√©rico de la pesta√±a"); return; }
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-<TU_ID_PUBLICACION>/pub?gid=" + encodeURIComponent(gid) + "&single=true&output=csv";
    const out = qs('sheets-url-output');
    if(out){ out.value = url; }
    const link = qs('sheets-open-url');
    if(link){ link.href = url; }
  };

  window.copyCurrentSheetsUrl = async function(){
    const out = qs('sheets-url-output');
    const v = (out?.value || "").trim();
    if(!v){ alert("No hay URL para copiar"); return; }
    try{
      await navigator.clipboard.writeText(v);
      alert("URL copiada al portapapeles");
    }catch(e){
      console.warn(e);
      out.select(); document.execCommand("copy");
      alert("URL copiada (fallback)");
    }
  };

  window.recheckSheetsStatus = async function(){
    try{
      const url = (qs('sheets-url-output')?.value || "").trim() || (getAppCfg().SHEETS_TERRITORIOS_CSV_URL || "").trim();
      if(!url){ window.setSheetsCsvStatus?.(false); return; }
      const res = await fetch(url, { cache: 'no-store', redirect: 'follow' });
      const ok = !!(res && res.ok);
      window.setSheetsCsvStatus?.(ok);
      if(ok){ alert("Conexi√≥n OK"); } else { alert("Sigue sin conectar"); }
    }catch(e){
      window.setSheetsCsvStatus?.(false);
      alert("Error al chequear");
    }
  };

  function initBadgeClick(){
    const badge = qs('sheets-status-badge');
    if(!badge) return;
    badge.style.cursor = "pointer";
    badge.addEventListener('click', ()=>{
      const isOff = badge.classList.contains('disconnected');
      if(isOff){ openSheetsHelp(); }
      else {
        const url = getAppCfg().SHEETS_TERRITORIOS_CSV_URL || "";
        if(url){
          navigator.clipboard?.writeText(url).then(()=>{
            badge.title = "URL copiada";
          }).catch(()=>{ badge.title = "No se pudo copiar"; });
        } else {
          openSheetsHelp();
        }
      }
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initBadgeClick);
  }else{
    initBadgeClick();
  }
})();
</script>

<script>
(function(){
  function qs(id){ return document.getElementById(id); }
  function getAppCfg(){ return window.APP_CONFIG || (window.APP_CONFIG = {}); }

  window.saveSheetsUrlToConfig = async function(){
    const inp = qs('sheets-url-output');
    const v = (inp?.value || "").trim();
    if(!v){ alert("Ingres√° una URL CSV v√°lida primero."); return; }
    const cfg = getAppCfg();
    cfg.SHEETS_TERRITORIOS_CSV_URL = v;
    try { localStorage.setItem('APP_CONFIG.SHEETS_TERRITORIOS_CSV_URL', v); } catch(e) {}
    try{
      if (typeof window.cargarDatosDesdeSheets === 'function'){
        await window.cargarDatosDesdeSheets();
        alert("URL aplicada y datos recargados.");
      } else {
        alert("URL aplicada. Recarg√° los datos desde el panel o refresc√° la p√°gina.");
      }
    }catch(e){
      console.warn(e);
      alert("URL aplicada. Si no ves cambios, refresc√° la p√°gina.");
    }
  };

  try{
    const stored = localStorage.getItem('APP_CONFIG.SHEETS_TERRITORIOS_CSV_URL');
    if (stored && (!getAppCfg().SHEETS_TERRITORIOS_CSV_URL)){
      getAppCfg().SHEETS_TERRITORIOS_CSV_URL = stored;
    }
  }catch(e){}
})();

document.addEventListener('DOMContentLoaded', () => {
  const novOverlay   = document.getElementById('novistar-overlay');
  const novForm      = document.getElementById('novistar-form');

  novOverlay?.addEventListener('click', (e) => {
    if (e.target === novOverlay) closeNovistarModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeNovistarModal();
  });

  novForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const payload = {
      lat: parseFloat(document.getElementById('novistar-lat').value),
      lng: parseFloat(document.getElementById('novistar-lng').value),
      direccion: (document.getElementById('novistar-direccion').value || '').trim(),
      motivo: document.getElementById('novistar-motivo').value,
      comentario: (document.getElementById('novistar-comentario').value || '').trim(),
      fecha: new Date().toISOString(),
      user: (typeof AuthApp !== "undefined" && AuthApp.getUsername ? (AuthApp.getUsername() || "anon") : "anon")
    };
    if (window.MapApp?.saveNoVisitarSuggestion) {
      window.MapApp.saveNoVisitarSuggestion(payload);
    } else {
      window.showToast?.('Sugerencia enviada (mock)');
      console.log('NoVisitar payload:', payload);
    }
    closeNovistarModal();
  });

  document.addEventListener('novistar:pick', (e) => {
    openNovistarModal(e.detail || {});
  });
 document.addEventListener('novistar:pick', (e) => {
    openNovistarModal(e.detail || {});
  });
});


</script>

</body>
</html>
