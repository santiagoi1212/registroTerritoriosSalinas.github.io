<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Territorios</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <link rel="stylesheet" href="./app.css" />

  <script src="./app-config.js"></script>
  <script src="./helpers.js"></script>
  <script src="./app-map.js"></script>
  <script src="./app-auth.js"></script>
</head>

<body>
  <!-- TOP BAR -->
  <div id="topbar">
    <div class="brand">Territorios</div>
    <div id="topbar-actions">
      <span id="auth-info" class="auth-hidden auth-user-label"></span>

      <!-- Botón abrir login -->
      <button id="btnAuthOpen" class="icon-btn primary" title="Acceder">
        <span class="icon">👤</span>
      </button>

      <!-- Botón logout -->
      <button id="btnLogout" class="icon-btn auth-hidden" title="Salir">
        <span class="icon">⏏</span>
      </button>
    </div>
  </div>

  <!-- AVISO DISTANCIA -->
  <div id="far-banner">⚠️ Estás a más de <strong>8 km</strong> del territorio. Las acciones quedaron desactivadas.</div>

  <!-- MAPA -->
  <div id="map"></div>

  <!-- BOTTOM BAR -->
  <div id="bottombar">
    <!-- GPS -->
    <button id="btn-geo" class="bb-item" data-active="off" title="Mi posición">
      <div class="bb-icon" id="icon-geo">📍</div>
      <div class="bb-label">Posición</div>
    </button>

    <!-- Predicación semanal -->
    <button id="btn-weekly-panel" class="bb-item" data-active="off" title="Predicación semanal">
      <div class="bb-icon" id="icon-weekly">📅</div>
      <div class="bb-label">Predicar</div>
    </button>

    <!-- Casas de familias -->
    <button id="btn-houses-toggle" class="bb-item" data-active="off" title="Casas de familias">
      <div class="bb-icon" id="icon-houses">🏠</div>
      <div class="bb-label">Casas</div>
    </button>

    <!-- Mostrar / ocultar números -->
    <button id="btnToggleLabels" class="bb-item" data-active="on" title="Mostrar / ocultar números" style="display:none">
      <div class="bb-icon" id="icon-labels">👁️</div>
      <div class="bb-label">Números</div>
    </button>

    <!-- Indicaciones / ruta -->
    <button id="btn-route-toggle" class="bb-item" data-active="off" title="Indicaciones">
      <div class="bb-icon" id="icon-route">🚗</div>
      <div class="bb-label">Ruta</div>
    </button>

    <!-- Referencias / info colores -->
    <button id="btn-info-toggle" class="bb-item" data-active="off" title="Información de colores" style="display:none">
      <div class="bb-icon" id="icon-info">ℹ️</div>
      <div class="bb-label">Info</div>
    </button>

  <!-- PANEL SEMANAL flotante -->
  <div id="weekly-panel" class="weekly-panel" hidden>
    <div class="weekly-title">Predicación Semanal</div>
    <div class="weekly-hint">Elegí una salida para verla en el mapa, o mostrarlas todas:</div>

    <button id="weekly-show-all" class="weekly-item weekly-item-all" type="button">
      👥 Mostrar todas las salidas
    </button>

    <div id="weekly-list" class="weekly-list">
      <!-- dinámico -->
    </div>
  </div>


  <!-- REFERENCIAS (colores de territorios) -->
  <div id="referencias">
    <h3>Referencias</h3>
    <div class="referencia"><span class="color-box azul"></span>Se está trabajando</div>
    <div class="referencia"><span class="color-box verde"></span>Finalizado &lt; 2 meses</div>
    <div class="referencia"><span class="color-box amarillo"></span>Finalizado 2-3 meses</div>
    <div class="referencia"><span class="color-box rojo"></span>Finalizado 3+ meses</div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="login-overlay" class="overlay">
    <div id="login-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <header class="modal-header">
        <h3 id="login-title" class="modal-title">Iniciar sesión</h3>
        <button id="login-close" class="modal-close-btn" title="Cerrar">✕</button>
      </header>

      <div class="modal-body">
        <div class="form-field">
          <label for="inUser" class="form-label">Usuario</label>
          <input id="inUser" class="form-input" autocomplete="username" />
        </div>

        <div class="form-field">
          <label for="inPass" class="form-label">Contraseña</label>
          <input id="inPass" class="form-input" type="password" autocomplete="current-password" />
        </div>

        <div class="form-actions">
          <button id="login-cancel" class="btn-cancel" type="button">Cancelar</button>
          <button id="btnLogin" class="btn-primary" type="button">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL REGISTRAR TERRITORIO -->
  <div id="territorio-overlay" class="overlay">
    <div id="territorio-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="territorio-title">
      <header class="modal-header">
        <h3 id="territorio-title" class="modal-title">Registrar territorio</h3>
        <button id="territorio-close" class="modal-close-btn" title="Cerrar">✕</button>
      </header>
      <div id="territorio-body" class="modal-body">
        <!-- se rellena dinámicamente -->
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="territorio-toast" class="toast"></div>

  <script>
  // ====== Toast global ======
  function showToast(msg){
    const t = document.getElementById("territorio-toast");
    t.textContent = msg || "";
    t.style.display = msg ? "block" : "none";
    if(msg){
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>t.style.display="none", 3000);
    }
  }
  window.showToast = showToast;

  // ====== DOM refs generales ======
  const btnAuthOpen    = document.getElementById('btnAuthOpen');
  const btnLogout      = document.getElementById('btnLogout');
  const overlayLogin   = document.getElementById('login-overlay');
  const btnLogin       = document.getElementById('btnLogin');
  const inUser         = document.getElementById('inUser');
  const inPass         = document.getElementById('inPass');
  const btnCloseLogin  = document.getElementById('login-close');
  const btnCancelLogin = document.getElementById('login-cancel');

  const btnGeo         = document.getElementById('btn-geo');
  const iconGeo        = document.getElementById('icon-geo');

  const btnWeekly      = document.getElementById('btn-weekly-panel');
  const iconWeekly     = document.getElementById('icon-weekly');
  const weeklyPanel    = document.getElementById('weekly-panel');
  const weeklyList     = document.getElementById('weekly-list');

  const btnHouses      = document.getElementById('btn-houses-toggle');
  const iconHouses     = document.getElementById('icon-houses');

  const btnLabels      = document.getElementById('btnToggleLabels');
  const iconLabels     = document.getElementById('icon-labels');

  const btnRoute       = document.getElementById('btn-route-toggle');
  const iconRoute      = document.getElementById('icon-route');

  const btnInfo        = document.getElementById('btn-info-toggle');
  const iconInfo       = document.getElementById('icon-info');
  const referenciasBox = document.getElementById('referencias');

  const territorioOverlay = document.getElementById('territorio-overlay');
  const territorioClose   = document.getElementById('territorio-close');
  const loginOverlay      = document.getElementById('login-overlay');

  // ====== Cerrar modales haciendo click afuera ======
  if (territorioClose){
    territorioClose.addEventListener('click', ()=>{
      territorioOverlay.style.display='none';
    });
  }
  if (territorioOverlay){
    territorioOverlay.addEventListener('click',(e)=>{
      if (e.target===territorioOverlay) territorioOverlay.style.display='none';
    });
  }
  if (loginOverlay){
    loginOverlay.addEventListener('click',(e)=>{
      if (e.target===loginOverlay) loginOverlay.style.display='none';
    });
  }

  // ====== Login modal open/close ======
  function openLogin(){
    overlayLogin.style.display='flex';
    inUser.focus();
  }
  function closeLogin(){
    overlayLogin.style.display='none';
  }

  btnAuthOpen.addEventListener('click', openLogin);
  btnCloseLogin.addEventListener('click', closeLogin);
  btnCancelLogin.addEventListener('click', closeLogin);

  btnLogin.addEventListener('click', () => {
    const u = (inUser.value||'').trim();
    const p = (inPass.value||'').trim();
    if (!u || !p){
      showToast('Ingresá usuario y contraseña');
      return;
    }
    window.AuthApp.doLogin(u,p);
    closeLogin();
  });

  btnLogout.addEventListener('click', () => {
    window.AuthApp.logout();
  });

  // ====== Estado Predicación semanal activo? ======
  let weeklyActive = false;

  // ====== GPS toggle ======
  btnGeo.addEventListener('click', async () => {
    const active = window.MapApp.isGeoActive();
    if (active) {
      window.MapApp.stopGeo();
      btnGeo.setAttribute("data-active","off");
      iconGeo.textContent = "📍";
    } else {
      window.MapApp.setWeeklyRoutingEnabled(weeklyActive);
      const ok = await window.MapApp.startGeo();
      if (ok){
        btnGeo.setAttribute("data-active","on");
        iconGeo.textContent = "📡";
      }
    }
  });

  document.addEventListener('geo:state', (e)=>{
    const active = !!(e.detail && e.detail.active);
    btnGeo.setAttribute("data-active", active ? "on" : "off");
    iconGeo.textContent = active ? "📡" : "📍";
  });

  // ====== Mostrar / Ocultar Números ======
  btnLabels.addEventListener('click', () => {
    const nowOn = window.MapApp.toggleLabels(); // devuelve true si quedan visibles
    if (nowOn){
      btnLabels.setAttribute("data-active","on");
      iconLabels.textContent = "👁️";
    } else {
      btnLabels.setAttribute("data-active","off");
      iconLabels.textContent = "👁️";
    }
  });

  // ====== Mostrar / Ocultar Casas ======
  btnHouses.addEventListener('click', () => {
    const visibleNow = window.MapApp.toggleHouses(); // true si visibles
    if (visibleNow){
      btnHouses.setAttribute("data-active","on");
      iconHouses.textContent = "🏠";
    } else {
      btnHouses.setAttribute("data-active","off");
      iconHouses.textContent = "🏠";
    }
  });

  function isMobileViewport() {
  return window.matchMedia("(max-width: 767px)").matches;
}

function minimizeWeeklyPanel() {
  // Si es móvil, minimizar visualmente
  if (isMobileViewport()) {
    weeklyPanel.classList.add("minimized");
  }
}

function restoreWeeklyPanel() {
  weeklyPanel.classList.remove("minimized");
}


  // ====== Predicación Semanal ======
btnWeekly.addEventListener('click', async () => {
  weeklyActive = !weeklyActive;
  window.MapApp.setWeeklyRoutingEnabled(weeklyActive);

  if (!weeklyActive){
    // === APAGANDO MODO PREDICAR ===
    btnWeekly.setAttribute("data-active","off");
    iconWeekly.textContent = "📅";

    weeklyPanel.hidden = true;
    restoreWeeklyPanel(); // por si estaba minimizado

    // limpiar selección individual / ruta
    window.MapApp.clearWeeklyPoint();
    window.MapApp.clearRoute();

    // apagar botón Ruta
    btnRoute.setAttribute("data-active","off");
    iconRoute.textContent = "🚗";



    return;
  }

  // === PRENDER MODO PREDICAR ===
  btnWeekly.setAttribute("data-active","on");
  iconWeekly.textContent = "✅";

  restoreWeeklyPanel(); // siempre lo abrimos "grande" al entrar
  weeklyPanel.hidden = false;

  // limpiar cualquier cosa anterior
  window.MapApp.clearWeeklyPoint();
  window.MapApp.clearRoute();
  btnRoute.setAttribute("data-active","off");
  iconRoute.textContent = "🚗";

  // reconstruir la lista
  weeklyList.innerHTML = "";
  const items = window.MapApp.getWeeklyPoints(); // WEEKLY_POINTS

  // Botón "Mostrar todas las salidas"
  const btnAll = document.getElementById('weekly-show-all');
  if (btnAll){
    btnAll.onclick = () => {
      // mostrar todos los puntos de predicación en el mapa
      window.MapApp.showWeeklyLayerWithRoutingOnClick();
      // no trazamos ruta todavía hasta que el usuario toque un punto
      window.MapApp.clearWeeklyPoint();
      window.MapApp.clearRoute();
      btnRoute.setAttribute("data-active","off");
      iconRoute.textContent = "🚗";

      // minimizar panel (en mobile)
      minimizeWeeklyPanel();
    };
  }

  // Cada salida individual
  items.forEach((it, idx) => {
    const div = document.createElement('div');
    div.className = 'weekly-item';
    div.textContent = it.label; // SOLO el lugar/nombre, sin día/hora

    div.addEventListener('click', async () => {
      // esconder la capa de todos

      // mostrar solo ese punto en el mapa y centrar
      await window.MapApp.showSingleWeeklyPoint(idx);

      // si GPS activo y routing habilitado, dibujar ruta automática
      if (weeklyActive && window.MapApp.isGeoActive()){
        btnRoute.setAttribute("data-active","on");
        iconRoute.textContent = "🛣️";
      } else {
        btnRoute.setAttribute("data-active","off");
        iconRoute.textContent = "🚗";
      }

      // minimizar panel en mobile para liberar mapa
      minimizeWeeklyPanel();
    });

    weeklyList.appendChild(div);
  });

});




btnRoute.addEventListener('click', async () => {
  const isOn = btnRoute.getAttribute("data-active") === "on";

  if (isOn) {
    // 🔻 Apagar ruta
    window.MapApp.clearRoute();
    btnRoute.setAttribute("data-active","off");
    iconRoute.textContent = "🚗";
    return;
  }

  // 🔺 Quieren encender ruta

  // 1. Si ya tenemos posición y un destino, perfecto.
  // 2. Si NO tenemos posición, la activamos y luego trazamos.
  // 3. Si NO tenemos destino, avisamos.

  // Intentar asegurar ruta con geolocalización activa
  const ok = await window.MapApp.ensureRouteWithGeo();

  if (ok) {
    btnRoute.setAttribute("data-active","on");
    iconRoute.textContent = "🛣️";
  } else {
    // Si no se pudo trazar ruta, nos aseguramos visualmente de dejar
    // el botón apagado para no mentirle al usuario.
    btnRoute.setAttribute("data-active","off");
    iconRoute.textContent = "🚗";
  }
});


  // ====== Info colores toggle ======
  btnInfo.addEventListener('click', ()=>{
    const active = btnInfo.getAttribute("data-active") === "on";
    if (active){
      btnInfo.setAttribute("data-active","off");
      iconInfo.textContent = "ℹ️";
      referenciasBox.style.display = "none";
    } else {
      btnInfo.setAttribute("data-active","on");
      iconInfo.textContent = "❌";
      referenciasBox.style.display = "block";
    }
  });

  // ====== Init general ======
  (async function boot(){
    const ok = await (async function waitFor(cond, timeoutMs){
      const start = Date.now();
      return new Promise((resolve)=>{
        (function loop(){
          if (cond()) return resolve(true);
          if (Date.now() - start > timeoutMs) return resolve(false);
          requestAnimationFrame(loop);
        })();
      });
    })(() => !!window.MapApp, 4000);

    if (!ok || !window.MapApp){
      console.error('MapApp no está disponible. Revisá errores de app-map.js.');
      showToast('No se pudo inicializar el mapa.');
      return;
    }

    await window.MapApp.init();
    await window.MapApp.ready;

    // restaurar sesión inicial
    await window.AuthApp.restore();
  })();
  </script>
</body>
</html>
