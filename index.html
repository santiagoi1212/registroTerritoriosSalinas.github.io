<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Territorios</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <link rel="stylesheet" href="./app.css" />

  <script src="./app-config.js"></script>
  <script src="./helpers.js"></script>
  <script src="./app-map.js"></script>
  <script src="./app-auth.js"></script>
</head>

<body>
  <!-- TOP BAR -->
  <div id="topbar">
    <div class="brand">Territorios</div>
    <div id="topbar-actions">
      <span id="auth-info" class="auth-hidden" style="margin-right:8px;"></span>
      <button id="btnAuthOpen" class="btn primary">Acceder</button>
      <button id="btnLogout" class="auth-hidden">Salir</button>
    </div>
  </div>

  <!-- SUB BAR -->
  <div id="subbar">
    <button id="btn-geo" class="btn">Mostrar Posici√≥n</button>
    <button id="btn-weekly-panel" class="btn">Predicaci√≥n Semanal</button>
    <button id="btnToggleLabels" class="btn">Ocultar N√∫meros</button>
  </div>

  <!-- AVISO DISTANCIA -->
  <div id="far-banner">‚ö†Ô∏è Est√°s a m√°s de <strong>8 km</strong> del territorio. Las acciones quedaron desactivadas.</div>

  <!-- MAPA -->
  <div id="map"></div>

  <!-- PANEL SEMANAL -->
  <div id="weekly-panel" class="weekly-panel" hidden>
    <div class="weekly-title">Predicaci√≥n Semanal</div>
    <div class="weekly-hint">Toc√° un punto para ver d√≥nde es y c√≥mo llegar:</div>
    <div id="weekly-list" class="weekly-list">
      <!-- Se llena din√°micamente con .weekly-item -->
    </div>
  </div>

  <!-- BOT√ìN FLOANTE PARA REABRIR SEMANAL -->
  <button id="btn-weekly-toggle-float">üìÖ Cambiar punto</button>

  <!-- REFERENCIAS -->
  <div id="referencias">
    <h3 style="margin-top:0">Referencias</h3>
    <div class="referencia"><span class="color-box azul"></span>Se est√° trabajando</div>
    <div class="referencia"><span class="color-box verde"></span>Menos de 2 meses (finalizado)</div>
    <div class="referencia"><span class="color-box amarillo"></span>M√°s de 2 y menos de 3 meses</div>
    <div class="referencia"><span class="color-box rojo"></span>3 meses o m√°s</div>
  </div>
  <button id="toggle-referencias">üìã Ver Informaci√≥n</button>

  <!-- LOGIN MODAL -->
  <div id="login-overlay" class="overlay">
    <div id="login-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <header class="modal-header">
        <h3 id="login-title" class="modal-title">Iniciar sesi√≥n</h3>
        <button id="login-close" class="modal-close-btn" title="Cerrar">‚úï</button>
      </header>

      <div class="modal-body">
        <div class="form-field">
          <label for="inUser" class="form-label">Usuario</label>
          <input id="inUser" class="form-input" autocomplete="username" />
        </div>

        <div class="form-field">
          <label for="inPass" class="form-label">Contrase√±a</label>
          <input id="inPass" class="form-input" type="password" autocomplete="current-password" />
        </div>

        <div class="form-actions">
          <button id="login-cancel" class="btn-cancel" type="button">Cancelar</button>
          <button id="btnLogin" class="btn-primary" type="button">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL REGISTRAR TERRITORIO -->
  <div id="territorio-overlay" class="overlay">
    <div id="territorio-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="territorio-title">
      <header class="modal-header">
        <h3 id="territorio-title" class="modal-title">Registrar territorio</h3>
        <button id="territorio-close" class="modal-close-btn" title="Cerrar">‚úï</button>
      </header>
      <div id="territorio-body" class="modal-body">
        <!-- se rellena din√°micamente -->
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="territorio-toast" class="toast"></div>

  <script>
  // ========== Overlays close ==========
  (function(){
    const loginOverlay = document.getElementById('login-overlay');
    const territorioOverlay = document.getElementById('territorio-overlay');
    const territorioClose = document.getElementById('territorio-close');

    if (territorioClose){
      territorioClose.addEventListener('click', ()=>{
        territorioOverlay.style.display='none';
      });
    }

    if (territorioOverlay){
      territorioOverlay.addEventListener('click',(e)=>{
        if (e.target===territorioOverlay) territorioOverlay.style.display='none';
      });
    }
    if (loginOverlay){
      loginOverlay.addEventListener('click',(e)=>{
        if (e.target===loginOverlay) loginOverlay.style.display='none';
      });
    }
  })();

  // ========== Toast global ==========
  function showToast(msg){
    const t = document.getElementById("territorio-toast");
    t.textContent = msg || "";
    t.style.display = msg ? "block" : "none";
    if(msg){
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>t.style.display="none", 3000);
    }
  }
  window.showToast = showToast;

  // ========== DOM refs ==========
  const btnAuthOpen      = document.getElementById('btnAuthOpen');
  const btnLogout        = document.getElementById('btnLogout');
  const overlayLogin     = document.getElementById('login-overlay');
  const btnLogin         = document.getElementById('btnLogin');
  const inUser           = document.getElementById('inUser');
  const inPass           = document.getElementById('inPass');
  const btnCloseLogin    = document.getElementById('login-close');
  const btnCancelLogin   = document.getElementById('login-cancel');

  const btnGeo           = document.getElementById('btn-geo');
  const btnWeekly        = document.getElementById('btn-weekly-panel');
  const btnWeeklyFloat   = document.getElementById('btn-weekly-toggle-float');
  const panelW           = document.getElementById('weekly-panel');
  const weeklyList       = document.getElementById('weekly-list');
  const btnInfo          = document.getElementById('toggle-referencias');
  const panelsInfo       = [document.getElementById('referencias')];
  const btnToggleLabels  = document.getElementById('btnToggleLabels');

  // ========== Login modal ==========
  function openLogin(){
    overlayLogin.style.display='flex';
    inUser.focus();
  }
  function closeLogin(){
    overlayLogin.style.display='none';
  }

  btnAuthOpen.addEventListener('click', openLogin);
  btnCloseLogin.addEventListener('click', closeLogin);
  btnCancelLogin.addEventListener('click', closeLogin);

  btnLogin.addEventListener('click', () => {
    const u = (inUser.value||'').trim();
    const p = (inPass.value||'').trim();
    if (!u || !p){
      showToast('Ingres√° usuario y contrase√±a');
      return;
    }
    window.AuthApp.doLogin(u,p);
    closeLogin();
  });

  btnLogout.addEventListener('click', () => {
    window.AuthApp.logout();
  });

  // ========== Geolocalizaci√≥n bot√≥n ==========
  let weeklyActive = false;

  btnGeo.addEventListener('click', async () => {
    const active = window.MapApp.isGeoActive();
    if (active) {
      window.MapApp.stopGeo();
      btnGeo.textContent = 'Mostrar Posici√≥n';
    } else {
      // si estamos en modo predicaci√≥n semanal, permitimos routing autom√°tico
      window.MapApp.setWeeklyRoutingEnabled(weeklyActive);
      const ok = await window.MapApp.startGeo();
      if (ok) btnGeo.textContent = 'Ocultar Posici√≥n';
    }
  });

  document.addEventListener('geo:state', (e)=>{
    const active = !!(e.detail && e.detail.active);
    btnGeo.textContent = active ? 'Ocultar Posici√≥n' : 'Mostrar Posici√≥n';
  });

  // ========== Mostrar / Ocultar N√∫meros ==========
  btnToggleLabels.addEventListener('click', () => {
    window.MapApp.toggleLabels();
  });

  // ========== Predicaci√≥n Semanal ==========
  // Abrir / cerrar panel
  btnWeekly.addEventListener('click', async () => {
    weeklyActive = !weeklyActive;
    window.MapApp.setWeeklyRoutingEnabled(weeklyActive);

    if (!weeklyActive){
      // saliendo del modo semanal
      btnWeekly.textContent = 'Predicaci√≥n Semanal';
      panelW.hidden = true;
      btnWeeklyFloat.style.display = 'none';
      window.MapApp.clearWeeklyPoint();
      window.MapApp.clearRoute();
      return;
    }

    // entrando al modo semanal
    btnWeekly.textContent = 'Quitar Predicaci√≥n Semanal';

    // Pedimos a MapApp la lista de puntos semanales y pintamos UI
    const items = window.MapApp.getWeeklyPoints();
    weeklyList.innerHTML = "";
    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'weekly-item';
      div.textContent = it.label;
      div.addEventListener('click', async () => {
        // usuario eligi√≥ este punto
        panelW.hidden = true;
        btnWeeklyFloat.style.display = 'block';

        await window.MapApp.selectWeeklyPoint(idx);
      });
      weeklyList.appendChild(div);
    });

    panelW.hidden = false;
  });

  // Bot√≥n flotante para volver a ver lista
  btnWeeklyFloat.addEventListener('click', () => {
    // reabrir panel con la lista sin salir del modo semanal
    const items = window.MapApp.getWeeklyPoints();
    weeklyList.innerHTML = "";
    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'weekly-item';
      div.textContent = it.label;
      div.addEventListener('click', async () => {
        panelW.hidden = true;
        btnWeeklyFloat.style.display = 'block';
        await window.MapApp.selectWeeklyPoint(idx);
      });
      weeklyList.appendChild(div);
    });

    panelW.hidden = false;
  });

  // ========== Referencias / Info ==========
  let infoVisible = false;
  btnInfo.addEventListener('click', ()=>{
    infoVisible = !infoVisible;
    panelsInfo.forEach(p => p.style.display = infoVisible ? 'block' : 'none');
    btnInfo.textContent = infoVisible ? '‚ùå Ocultar Informaci√≥n' : 'üìã Ver Informaci√≥n';
  });

  // ========== Init general ==========
  (async function boot(){
    // esperamos MapApp
    const ok = await (async function waitFor(cond, timeoutMs){
      const start = Date.now();
      return new Promise((resolve)=>{
        (function loop(){
          if (cond()) return resolve(true);
          if (Date.now() - start > timeoutMs) return resolve(false);
          requestAnimationFrame(loop);
        })();
      });
    })(() => !!window.MapApp, 4000);

    if (!ok || !window.MapApp){
      console.error('MapApp no est√° disponible. Revis√° errores de app-map.js.');
      showToast('No se pudo inicializar el mapa.');
      return;
    }

    await window.MapApp.init();
    await window.MapApp.ready;

    // restaurar sesi√≥n inicial
    await window.AuthApp.restore();
  })();
  </script>
</body>
</html>
